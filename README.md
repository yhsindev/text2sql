# text2sql 
ROUTE 代碼分析

## 一、載入套件

1. **數據處理**：
   - `json`：用於讀寫 JSON 格式數據。
   - `copy`：用於創建對象的深拷貝。
   - `csv`：用於讀寫 CSV 文件。
   - `re`（正則表達式庫）：用於文本模式匹配、查找、替換等操作。
   - `sqlite3`：用於與 SQLite 資料庫交互。

2. **錯誤處理**：
   - `traceback`：用於捕獲並顯示錯誤信息，幫助調試和處理異常。

3. **資源管理**：
   - `os`：提供操作系統相關功能，如設置環境變量、管理文件系統。

4. **模型生成**：
   - `vllm`：用於運行語言模型並生成相應的回應，支持多種模型結構。

5. **計算超時**：
   - `func_timeout`：用於設置超時限制，防止函數長時間無回應。

6. **進度顯示**：
   - `tqdm`：用於顯示進度條，幫助跟蹤任務的進度。

## 二、訓練前處理  
### 1. 生成 SQL 查詢的提示欄位模板

- **`prompt_temp`**：
  - **功能**：生成 SQL 查詢提示，包含資料庫架構、範例資料、問題描述和提示語，讓模型生成有效的 SQL 查詢。
  
- **`prompt_sl_temp_sft`**：
  - **功能**：指示模型從資料庫架構和問題中提取相關表格和欄位，而不是直接生成 SQL 查詢，並且要求模型只輸出所需的表格和欄位。

- **`prompt_sl_temp`**：
  - **功能**：提供模型範例，展示如何根據問題選擇相關表格和欄位，並以 JSON 格式輸出映射，無需生成 SQL 語句。

### 2. SQL 查詢正確性檢查

- **`prompt_nc_temp_sft`**：
  - **功能**：檢查生成的 SQL 查詢是否能正確回答問題，如果不能，請提供正確的 SQL 查詢。

- **`prompt_nc_temp`**：
  - **功能**：同上，並提供範例，展示正確和錯誤的 SQL 查詢，幫助模型理解如何修正不正確的查詢。

### 3. SQL 查詢補全（繼續寫作）

- **`prompt_cw_temp_sft`**：
  - **功能**：將不完整的 SQL 查詢補全為完整的查詢，確保它能正確回答問題。

- **`prompt_cw_temp`**：
  - **功能**：同上，並提供範例，展示如何將不完整的 SQL 查詢補全為正確的查詢。

### 4. 數據處理與模型運行

- **`read_json_file`**：
  - **功能**：讀取 JSON 文件並將其轉換為 Python 數據結構（如字典或列表）。

- **`LLM_Model` 類**：
  - **功能**：用於初始化語言模型，設置生成參數並生成回應（SQL 查詢）。

- **`generate_response`**：
  - **功能**：根據給定的提示（`prompts`）生成回應，並根據參數（如 `temperature`, `top_p`）控制生成的隨機性。

### 5. 資料庫操作

- **`get_schema_dict`**：
  - **功能**：從 SQLite 資料庫中提取結構信息（表格名、欄位名、資料類型等）並整理成字典。

- **`filter_dict_by_sql`**、**`filter_dict_by_sl`**：
  - **功能**：根據 SQL 查詢過濾資料庫結構，保留與查詢相關的表格和欄位。

- **`execute_query`**：
  - **功能**：執行 SQL 查詢並檢查結果，根據執行是否成功進行後續處理。

### 6. 訓練過程設置

- **`eval_all`**：
  - **功能**：解析數據集、設置訓練參數、生成 SQL 查詢提示、執行 SQL 查詢生成，並對查詢進行後處理（如噪聲修正、查詢補全等）。

- **`usegpu`**：
  - **功能**：根據 GPU 使用情況自動選擇空閒的 GPU 並設置環境變量。

---


